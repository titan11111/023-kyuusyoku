<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>„Åç„ÇÖ„ÅÜ„Åó„Çá„ÅèÂΩìÁï™„É™„Ç∫„É†ÔºöRemix</title>
    <style>
        /* =========================================
           REMIX STYLE (Dynamic & Slot & Voices & Faces)
           ========================================= */
        :root {
            --primary-color: #ff8e8e;
            --accent-color: #ffd700;
            --text-color: #333;
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Kyokasho ICA', sans-serif;
            background-color: #222;
            background-image: url('haikei.png'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            backdrop-filter: brightness(0.9);
        }

        .crt-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.4;
        }
        
        .game-container {
            max-width: 800px;
            width: 98%;
            height: 92vh;
            max-height: 800px;
            background: rgba(249, 249, 249, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 4px solid #444;
            padding-bottom: var(--safe-bottom);
        }

        .screen {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            transition: opacity 0.3s ease;
            position: relative;
        }
        .screen.hidden { display: none; }

        #title-screen { background: rgba(255, 251, 230, 0.8); }

        h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            margin-bottom: 1rem;
            color: #d35400;
            text-shadow: 2px 2px 0px #fff;
            text-align: center;
            line-height: 1.2;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
            user-select: none;
            transition: transform 0.05s, box-shadow 0.05s;
        }

        .big-button {
            background: #ff6b6b;
            color: white;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            box-shadow: 0 6px 0 #c0392b;
            margin: 10px;
        }
        .big-button:active { transform: translateY(6px); box-shadow: 0 0 0 #c0392b; }

        .secondary-button {
            background: #95a5a6;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 0 #7f8c8d;
        }
        .secondary-button:active { transform: translateY(4px); box-shadow: 0 0 0 #7f8c8d; }

        .refresh-button {
            background: #e67e22;
            color: white;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 8px;
            box-shadow: 0 4px 0 #d35400;
            width: 100%;
            margin-top: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .refresh-button:active { transform: translateY(4px); box-shadow: 0 0 0 #d35400; }
        .refresh-button span { font-size: 1.2em; }

        .game-header {
            width: 100%;
            padding: 10px;
            padding-top: max(10px, var(--safe-top));
            background: #34495e;
            color: white;
            display: flex;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .pill {
            background: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1rem;
            display: flex;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }
        .pill span { font-weight: bold; margin-left: 5px; color: #f1c40f; }

        .hurry-up .game-header {
            background: #c0392b;
            animation: pulse-header 0.5s infinite alternate;
        }
        @keyframes pulse-header { from { background: #c0392b; } to { background: #e74c3c; } }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column; 
            width: 100%;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        .student-area {
            flex: 0 0 auto;
            display: flex;
            justify-content: center;
            z-index: 5;
        }

        .student-card {
            background: white;
            border: 4px solid #2ecc71;
            border-radius: 15px;
            padding: 15px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: background-color 0.2s;
        }
        
        .fever-mode .student-card {
            border-color: #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.6);
            background: #fffff0;
        }

        .student-face { font-size: 4rem; line-height: 1; margin-bottom: 5px; }
        .student-name { font-weight: bold; font-size: 1.1rem; color: #27ae60; margin-bottom: 5px;}
        
        .student-comment-box {
            position: relative;
            background: #f0f8ff;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 10px;
            margin-top: 5px;
            font-weight: bold;
            font-size: 1.1rem;
            color: #2980b9;
        }
        .student-comment-box::after {
            content: '';
            position: absolute;
            top: -10px; left: 50%;
            margin-left: -10px;
            border-width: 0 10px 10px;
            border-style: solid;
            border-color: #3498db transparent;
            display: block;
            width: 0;
        }

        .menu-selection {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .menu-header { 
            text-align: center; font-size: 0.9rem; margin-bottom: 5px; color: #7f8c8d; 
            display: flex; justify-content: space-between; padding: 0 10px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 5px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .menu-btn {
            background: #fff;
            border: 1px solid #bdc3c7;
            border-bottom: 4px solid #95a5a6;
            border-radius: 8px;
            padding: 6px 2px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #2c3e50;
            min-height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1.2;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
        }

        .menu-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0px;
            background: #ecf0f1;
            border-color: #bdc3c7;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .menu-btn.new-item {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .reaction-area {
            position: absolute;
            bottom: calc(80px + var(--safe-bottom));
            left: 0; right: 0;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 20;
        }
        .reaction-msg {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(10px) scale(0.9);
            transition: all 0.2s;
        }
        .reaction-msg.show { opacity: 1; transform: translateY(0) scale(1); }
        .reaction-msg.good { color: #27ae60; border: 3px solid #2ecc71; background: #f0fff4; }
        .reaction-msg.bad { color: #c0392b; border: 3px solid #e74c3c; background: #fff5f5; }

        .float-score {
            position: absolute;
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 1px 1px 0 #fff;
            z-index: 100;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        .result-rank {
            font-size: 5rem;
            font-weight: 900;
            color: #f1c40f;
            text-shadow: 3px 3px 0 #d35400;
            margin: 10px 0;
        }

        /* --- Result Screen Styles --- */
        .result-comments-section {
            width: 100%;
            max-width: 450px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 12px;
        }
        .result-comments-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }
        .student-voice {
            background: #fff;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
            font-size: 0.85rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: slideIn 0.5s ease-out forwards;
            opacity: 0;
            transform: translateX(-20px);
        }
        .student-voice:nth-child(1) { animation-delay: 0.2s; }
        .student-voice:nth-child(2) { animation-delay: 0.4s; }
        .student-voice:nth-child(3) { animation-delay: 0.6s; }

        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }

        /* PC/Tablet Adjustments */
        @media (min-width: 600px) {
            .game-main { flex-direction: row; align-items: flex-start; }
            .student-area { width: 40%; }
            .menu-selection { width: 60%; height: 100%; }
            .menu-grid { grid-template-columns: repeat(4, 1fr); }
            .student-card { padding: 30px; }
            .student-comment-box { font-size: 1.3rem; padding: 15px; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.3s ease-in-out; }

        .time-penalty {
            color: #e74c3c;
            font-weight: bold;
            animation: fadeUp 1s forwards;
            position: absolute;
            right: -30px; top: 0;
        }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>
    <div class="game-container">
        <div id="title-screen" class="screen">
            <h1>Áµ¶È£üÂΩìÁï™<br>„É™„Ç∫„É†<br><span style="font-size:0.5em; color:#555;">„ÄúÊ∞ó„Åæ„Åê„ÇåÊ≥®ÊñáÁ∑®„Äú</span></h1>
            <p style="text-align:center; font-size:0.9rem; margin-bottom:20px; color:#555;">
                ÁîüÂæí„ÅÆ„ÄåÊ∞óÂàÜ„Äç„Å´Âêà„Çè„Åõ„Å¶<br>„É°„Éã„É•„Éº„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ
            </p>
            <button id="start-btn" class="big-button">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
            <div style="margin-top:10px;">
                <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
                    <input type="checkbox" id="hard-mode-toggle"> <span>„Éè„Éº„Éâ„É¢„Éº„Éâ</span>
                </label>
            </div>
        </div>

        <div id="game-screen" class="screen hidden">
            <div class="game-header">
                <div class="pill">SCORE: <span id="score">0</span></div>
                <div class="pill">TIME: <span id="timer">60</span></div>
                <div class="pill">COMBO: <span id="combo">0</span></div>
                <div class="pill">DONE: <span id="served">0</span></div>
            </div>

            <div class="game-main">
                <div class="student-area">
                    <div id="current-student" class="student-card">
                        </div>
                </div>
                
                <div class="menu-selection">
                    <div class="menu-header">
                        <span>Ê≥®Êñá„Å´Âêà„ÅÜ„É°„Éã„É•„Éº„Çí„Çø„ÉÉ„ÉóÔºÅ</span>
                    </div>
                    <div id="menu-grid" class="menu-grid">
                        </div>
                    <button id="refresh-btn" class="refresh-button">
                        <span>üîÑ</span> „É°„Éã„É•„ÉºÂÖ•Êõø (-5Áßí)
                    </button>
                </div>
            </div>

            <div class="reaction-area">
                <div id="reaction-message" class="reaction-msg"></div>
            </div>
        </div>

        <div id="result-screen" class="screen hidden">
            <h2>Êú¨Êó•„ÅÆÁµêÊûú</h2>
            <div class="result-rank" id="final-rank">S</div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%; max-width:400px; margin-bottom:15px;">
                <div style="background:#fff; padding:10px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <div style="font-size:0.8rem; color:#7f8c8d;">„Çπ„Ç≥„Ç¢</div>
                    <div id="final-score" style="font-size:1.5rem; font-weight:bold;">0</div>
                </div>
                <div style="background:#fff; padding:10px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                    <div style="font-size:0.8rem; color:#7f8c8d;">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
                    <div id="final-combo" style="font-size:1.5rem; font-weight:bold;">0</div>
                </div>
            </div>

            <div class="result-comments-section">
                <div class="result-comments-title">üì¢ ÁîüÂæí„Åü„Å°„ÅÆÂ£∞</div>
                <div id="result-comments-list">
                    </div>
            </div>

            <button id="restart-btn" class="big-button">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂</button>
            <button id="title-btn" class="secondary-button">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
        </div>
    </div>

    <audio id="bgm-game" src="kyuusyoku.mp3" loop preload="auto"></audio>
    <audio id="bgm-result" src="Golden Lamp Glow.mp3" loop preload="auto"></audio>

    <script>
        // --- „Éá„Éº„ÇøÂÆöÁæ© (È°îÂ∑ÆÂàÜÂØæÂøúÁâà) ---
        const students = [
            // 1Ë°åÁõÆ
            { name: "„Çø„Ç±„ÉÄ", face: { normal: "üòÅ", good: "üòÜ", bad: "üò´" } },
            { name: "„Çµ„Éà„Ç¶", face: { normal: "üëß", good: "üòç", bad: "üò≠" } },
            { name: "„Ç™„Ç™„Éè„Ç∑", face: { normal: "üòé", good: "ü§©", bad: "üòµ" } },
            { name: "„Éä„Ç´„Ç∏„Éû", face: { normal: "ü•¥", good: "ü§§", bad: "ü§Æ" } },
            
            // 2Ë°åÁõÆ
            { name: "„É§„Éû„É¢„Éà", face: { normal: "üòã", good: "üòù", bad: "ü§¢" } },
            { name: "„Éï„Ç∏„Ç§", face: { normal: "ü•õ", good: "üêÆ", bad: "ü§ß" } }, 
            { name: "„Éà„Éü„Éä„Ç¨", face: { normal: "ü•∫", good: "ü•∞", bad: "ü§¨" } },
            { name: "„ÇØ„Éâ„Ç¶", face: { normal: "üçñ", good: "ü¶Å", bad: "ü¶¥" } }, 
            
            // 3Ë°åÁõÆ
            { name: "„Ç§„Ç∑„Ç§", face: { normal: "üòç", good: "üòò", bad: "üíî" } },
            { name: "„Éä„Ç¨„Ç™„Ç´", face: { normal: "üçµ", good: "üë¥", bad: "‚òï" } },
            { name: "„Éü„É§„Ç∂„ÉØ", face: { normal: "üòñ", good: "üò§", bad: "üò±" } },
            { name: "„Éõ„ÇΩ„Ç´„ÉØ", face: { normal: "üò±", good: "üòá", bad: "üíÄ" } },
            
            // 4Ë°åÁõÆ
            { name: "„Ç≠„É†„É©", face: { normal: "üçÑ", good: "üçÑ‚ú®", bad: "üçÑüî•" } },
            { name: "„Éè„Çª„Ç¨„ÉØ", face: { normal: "ü•∞", good: "üíè", bad: "üíî" } },
            { name: "„Çø„Ç´„Éè„Ç∑", face: { normal: "üí™", good: "üèãÔ∏è", bad: "ü§ï" } },
            { name: "„Ç§„Éé„Ç¶„Ç®", face: { normal: "üêü", good: "üê†", bad: "üê°" } }, 
            
            // 5Ë°åÁõÆ
            { name: "„Çµ„Ç®„Ç≠", face: { normal: "ü§¢", good: "ü§Æ", bad: "üßü" } },
            { name: "„É®„Ç∑„ÉÄ", face: { normal: "üòå", good: "‚ò∫Ô∏è", bad: "üòÆ‚Äçüí®" } },
            { name: "„É§„Éû„ÉÄ", face: { normal: "üò¨", good: "üòÅ", bad: "ü•∂" } },
            { name: "„Éä„Ç¨„Çø", face: { normal: "üòí", good: "üòè", bad: "üò°" } },
            
            // 6Ë°åÁõÆ
            { name: "„Ç´„Éç„Ç≥", face: { normal: "üò§", good: "üòÜ", bad: "ü§Ø" } },
            { name: "„Ç¶„Ç®„Éè„É©", face: { normal: "üçù", good: "üáÆüáπ", bad: "üçû" } }, 
            { name: "„É¢„É™", face: { normal: "ü§î", good: "üí°", bad: "üåÄ" } },
            { name: "„Çø„Éã„Ç∞„ÉÅ", face: { normal: "üçÖ", good: "ü•ó", bad: "üêõ" } },
            
            // 7Ë°åÁõÆ
            { name: "„Éè„Éû„ÉÄ", face: { normal: "üçó", good: "üçó‚ú®", bad: "ü¶¥" } },
            { name: "„Ç∑„Éê„Çø", face: { normal: "üçÜ", good: "üçÜ‚ú®", bad: "ü•Ä" } },
            { name: "„ÇØ„É©„É¢„Éà", face: { normal: "üçö", good: "üçô", bad: "üçû" } }, 
            { name: "„Ç¢„É≥„Éâ„Ç¶", face: { normal: "‚ú®", good: "üíñ", bad: "üí§" } },
            
            // 8Ë°åÁõÆ
            { name: "„Ç´„ÉØ„Çµ„Ç≠", face: { normal: "üçú", good: "üç•", bad: "ü•£" } }, 
            { name: "„Ç™„ÇØ„ÉÄ", face: { normal: "üôè", good: "üëå", bad: "üëé" } },
            { name: "„Éé„Éä„Ç´", face: { normal: "üçÖ", good: "üçÖ‚ú®", bad: "üçÖüí®" } },
            { name: "„ÉÑ„Ç∏„É¢„Éà", face: { normal: "‚õÑ", good: "‚òÉÔ∏è", bad: "‚òÄÔ∏è" } }
        ];

        // „É°„Éã„É•„Éº„Å®„Çø„Ç∞
        const menuDatabase = [
            { name: "„Ç´„É¨„Éº„É©„Ç§„Çπ", tags: ["Ëæõ„ÅÑ", "„ÅîÈ£Ø", "„Ç¨„ÉÉ„ÉÑ„É™", "Ëå∂Ëâ≤", "Ê∏©„Åã„ÅÑ"] },
            { name: "„Éü„É´„É°„Éº„ÇØÁâõ‰π≥", tags: ["Áîò„ÅÑ", "È£≤„ÅøÁâ©", "ÁôΩ„ÅÑ"] },
            { name: "ÂÜ∑Âáç„Åø„Åã„Çì", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÂÜ∑„Åü„ÅÑ", "ÈªÑËâ≤"] },
            { name: "„ÇΩ„Éï„ÉàÈ∫∫„Éü„Éº„Éà„ÇΩ„Éº„Çπ", tags: ["È∫∫", "Ëµ§„ÅÑ", "„Ç¨„ÉÉ„ÉÑ„É™", "Ê∏©„Åã„ÅÑ"] },
            { name: "Êèö„Åí„Éë„É≥", tags: ["Áîò„ÅÑ", "„Éë„É≥", "Ëå∂Ëâ≤", "‰∫∫Ê∞ó"] },
            { name: "Áâõ‰π≥", tags: ["ÁôΩ„ÅÑ", "È£≤„ÅøÁâ©"] },
            { name: "„Åç„Å™„Åì„Éë„É≥", tags: ["Áîò„ÅÑ", "„Éë„É≥", "Ëå∂Ëâ≤", "‰∫∫Ê∞ó"] },
            { name: "„Éè„É†„Ç´„ÉÑ", tags: ["„Ç¨„ÉÉ„ÉÑ„É™", "Êèö„ÅíÁâ©", "Ëå∂Ëâ≤"] },
            { name: "„Éü„É´„ÇØÂØíÂ§©", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÁôΩ„ÅÑ", "ÂÜ∑„Åü„ÅÑ"] },
            { name: "„Åï„Å∞„ÅÆÂë≥ÂôåÁÖÆ", tags: ["È≠ö", "Ëå∂Ëâ≤", "ÂíåÈ£ü", "Ê∏©„Åã„ÅÑ"] },
            { name: "„Ç≥„ÉÉ„Éö„Éë„É≥", tags: ["„Éë„É≥", "Ëå∂Ëâ≤"] },
            { name: "„Çµ„É©„ÉÄ„Çπ„Éë„Ç≤„ÉÜ„Ç£", tags: ["È∫∫", "ÈáéËèú", "ÂÜ∑„Åü„ÅÑ", "„Åï„Å£„Å±„Çä"] },
            { name: "„Çè„Åã„ÇÅ„Çπ„Éº„Éó", tags: ["Ê±ÅÁâ©", "Ê∏©„Åã„ÅÑ", "„Åï„Å£„Å±„Çä"] },
            { name: "ÁÑº„Åç„Åù„Å∞", tags: ["È∫∫", "Ëå∂Ëâ≤", "„Ç¨„ÉÉ„ÉÑ„É™", "ÈáéËèú"] },
            { name: "„Åç„ÅÆ„Åì„ÇΩ„ÉÜ„Éº", tags: ["ÈáéËèú", "„Åç„ÅÆ„Åì", "Ëå∂Ëâ≤"] },
            { name: "„Éï„É´„Éº„ÉÑ„Éù„É≥„ÉÅ", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÂÜ∑„Åü„ÅÑ"] },
            { name: "„Ç´„ÉÑ„Ç´„É¨„Éº", tags: ["Ëæõ„ÅÑ", "„ÅîÈ£Ø", "„Ç¨„ÉÉ„ÉÑ„É™", "Ëå∂Ëâ≤", "ËÇâ"] },
            { name: "„Çµ„É©„ÉÄ", tags: ["ÈáéËèú", "„Åï„Å£„Å±„Çä", "ÂÜ∑„Åü„ÅÑ"] },
            { name: "„Åü„Åæ„Åî„Çπ„Éº„Éó", tags: ["Ê±ÅÁâ©", "ÈªÑËâ≤", "Ê∏©„Åã„ÅÑ"] },
            { name: "ÁÑº„ÅçÈ≠ö", tags: ["È≠ö", "ÂíåÈ£ü", "Ê∏©„Åã„ÅÑ"] },
            { name: "Áâõ‰π≥„Éó„É™„É≥", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÁôΩ„ÅÑ"] },
            { name: "ÈÖ¢„ÅÆÁâ©", tags: ["ÈáéËèú", "„Åï„Å£„Å±„Çä", "ÂÜ∑„Åü„ÅÑ", "ÂíåÈ£ü"] },
            { name: "„Åä„Åß„Çì", tags: ["Ê±ÅÁâ©", "Ê∏©„Åã„ÅÑ", "ÂíåÈ£ü", "Ëå∂Ëâ≤"] },
            { name: "‰∏≠ËèØ‰∏º", tags: ["„ÅîÈ£Ø", "ÈáéËèú", "Ê∏©„Åã„ÅÑ", "„Ç¨„ÉÉ„ÉÑ„É™"] },
            { name: "„Éë„Ç§„Éä„ÉÉ„Éó„É´", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÈªÑËâ≤", "ÂÜ∑„Åü„ÅÑ"] },
            { name: "ÁôΩ„Åî„ÅØ„Çì", tags: ["„ÅîÈ£Ø", "ÁôΩ„ÅÑ", "ÂíåÈ£ü"] },
            { name: "„Ç∑„ÉÅ„É•„Éº", tags: ["Ê±ÅÁâ©", "ÁôΩ„ÅÑ", "Ê∏©„Åã„ÅÑ", "ÈáéËèú"] },
            { name: "„Éä„Éù„É™„Çø„É≥", tags: ["È∫∫", "Ëµ§„ÅÑ", "ÈáéËèú"] },
            { name: "ÁÑº„Åç„ÅÜ„Å©„Çì", tags: ["È∫∫", "Ê∏©„Åã„ÅÑ", "ÈáéËèú"] },
            { name: "„Å≤„Åò„Åç", tags: ["ÂíåÈ£ü", "Èªí„ÅÑ", "ÈáéËèú"] },
            { name: "„ÉÅ„Ç≠„É≥„É©„Ç§„Çπ", tags: ["„ÅîÈ£Ø", "Ëµ§„ÅÑ", "ËÇâ"] },
            { name: "ÈáéËèú„Çπ„Éº„Éó", tags: ["Ê±ÅÁâ©", "ÈáéËèú", "Ê∏©„Åã„ÅÑ"] },
            { name: "„Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥", tags: ["ËÇâ", "Êèö„ÅíÁâ©", "Ëå∂Ëâ≤", "„Ç¨„ÉÉ„ÉÑ„É™"] },
            { name: "„Ç≥„Éº„É≥„Çπ„Éº„Éó", tags: ["Ê±ÅÁâ©", "ÈªÑËâ≤", "Ê∏©„Åã„ÅÑ", "Áîò„ÅÑ"] },
            { name: "„ÉÅ„É£„Éº„Éè„É≥", tags: ["„ÅîÈ£Ø", "‰∏≠ËèØ", "„Ç¨„ÉÉ„ÉÑ„É™"] },
            { name: "„Éï„É´„Éº„ÉÑ„É®„Éº„Ç∞„É´„Éà", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÁôΩ„ÅÑ"] },
            { name: "„Ç´„Éú„ÉÅ„É£„ÅÆÁÖÆÁâ©", tags: ["ÈáéËèú", "Áîò„ÅÑ", "ÈªÑËâ≤", "ÂíåÈ£ü"] },
            { name: "„Ç´„É¨„Éº„ÅÜ„Å©„Çì", tags: ["È∫∫", "Ëæõ„ÅÑ", "Ê∏©„Åã„ÅÑ", "Ëå∂Ëâ≤"] },
            { name: "„Åì„Çì„Å´„ÇÉ„Åè", tags: ["Èªí„ÅÑ", "„Éò„É´„Ç∑„Éº"] },
            { name: "„Éü„Éç„Çπ„Éà„É≠„Éº„Éç", tags: ["Ê±ÅÁâ©", "Ëµ§„ÅÑ", "ÈáéËèú", "Ê∏©„Åã„ÅÑ"] },
            { name: "„Éè„É≥„Éê„Éº„Ç∞", tags: ["ËÇâ", "„Ç¨„ÉÉ„ÉÑ„É™", "Ëå∂Ëâ≤", "‰∫∫Ê∞ó"] },
            { name: "„Éà„Éû„Éà", tags: ["Ëµ§„ÅÑ", "ÈáéËèú", "ÂÜ∑„Åü„ÅÑ"] },
            { name: "ÂÜ∑„ÇÑ„Åó‰∏≠ËèØ", tags: ["È∫∫", "ÂÜ∑„Åü„ÅÑ", "„Åï„Å£„Å±„Çä", "Â§è"] },
            { name: "ÈáéËèúÁÇí„ÇÅ", tags: ["ÈáéËèú", "Ê∏©„Åã„ÅÑ", "‰∏≠ËèØ"] },
            { name: "„Çº„É™„Éº", tags: ["Áîò„ÅÑ", "„Éá„Ç∂„Éº„Éà", "ÂÜ∑„Åü„ÅÑ"] }
        ];

        // „Éí„É≥„ÉàÔºàË¶ÅÊ±Ç„Ç´„ÉÜ„Ç¥„É™Ôºâ
        const hintTypes = [
            { label: "„ÉÑ„É´„ÉÑ„É´„Åó„Åü„ÇÇ„ÅÆ„ÅåÈ£ü„Åπ„Åü„ÅÑ„Å™", tag: "È∫∫" },
            { label: "ÁôΩ„ÅÑÈ£ü„ÅπÁâ©„Åå„ÅÑ„ÅÑ„Å™", tag: "ÁôΩ„ÅÑ" },
            { label: "‰ªäÊó•„ÅØ„Ç¨„ÉÉ„ÉÑ„É™„ÅÑ„Åç„Åü„ÅÑÔºÅ", tag: "„Ç¨„ÉÉ„ÉÑ„É™" },
            { label: "Áîò„ÅÑ„ÇÇ„ÅÆ„ÅåÈ£ü„Åπ„Åü„ÅÑÊ∞óÂàÜ", tag: "Áîò„ÅÑ" },
            { label: "Ê∏©„Åã„ÅÑÊ±ÅÁâ©„Åå„Åª„Åó„ÅÑ„Å™", tag: "Ê±ÅÁâ©" },
            { label: "„Éë„É≥Ê¥æ„Å™„Çì„Å†„Çà„Å≠", tag: "„Éë„É≥" },
            { label: "„ÅîÈ£Ø„ÇÇ„ÅÆ„Çí„ÅäÈ°ò„ÅÑÔºÅ", tag: "„ÅîÈ£Ø" },
            { label: "ÈáéËèú‰∏çË∂≥„Åß‚Ä¶", tag: "ÈáéËèú" },
            { label: "Ëæõ„ÅÑÂà∫ÊøÄ„Åå„Åª„Åó„ÅÑÔºÅ", tag: "Ëæõ„ÅÑ" },
            { label: "„Åï„Å£„Å±„Çä„Åó„Åü„ÇÇ„ÅÆ„Åå„ÅÑ„ÅÑ", tag: "„Åï„Å£„Å±„Çä" },
            { label: "Ëå∂Ëâ≤„ÅÑ„Åä„Åã„Åö„ÅØÊ≠£Áæ©ÔºÅ", tag: "Ëå∂Ëâ≤" },
            { label: "Ëµ§„ÅÑÈ£ü„ÅπÁâ©„ÅÇ„ÇãÔºü", tag: "Ëµ§„ÅÑ" },
            { label: "ÈªÑËâ≤„ÅÑÈ£ü„ÅπÁâ©„ÅÇ„ÇãÔºü", tag: "ÈªÑËâ≤" },
            { label: "„ÅäËÇâ„ÅåÈ£ü„Åπ„Åü„ÅÑÔºÅ", tag: "ËÇâ" },
            { label: "„ÅÆ„Å©‰πæ„ÅÑ„Åü„Äú", tag: "È£≤„ÅøÁâ©" },
            { label: "ÂíåÈ£ü„ÅßËêΩ„Å°ÁùÄ„Åç„Åü„ÅÑ", tag: "ÂíåÈ£ü" }
        ];

        // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Ç≥„É°„É≥„Éà
        const endingComments = {
            high: [ 
                "‰ªäÊó•„ÅÆÁµ¶È£ü„ÄÅ„Éû„Ç∏„ÅßÁ•û„Å£„Å¶„ÅüÔºÅ„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ",
                "ÂÆåÁíß„Å™ÈÖçËÜ≥„Å†‚Ä¶ÔºÅÂêõ„ÄÅ„Éó„É≠„ÅÆÁµ¶È£üÂΩìÁï™„Å†„Å≠ÔºÅ",
                "È£ü„Åπ„Åü„ÅÑ„ÇÇ„ÅÆ„ÅåÂÖ®ÈÉ®Âá∫„Å¶„Åç„ÅüÔºÅ„Ç®„Çπ„Éë„Éº„Å™„ÅÆÔºü",
                "„ÇØ„É©„Çπ„ÅÆ„Åø„Çì„Å™„ÅåÂêõ„ÅÆÈÖçËÜ≥„ÇíÂæÖ„Å£„Å¶„Çã„ÇàÔºÅ",
                "ÊúÄÈ´ò„ÅÆ„É©„É≥„ÉÅ„Çø„Ç§„É†„Å†„Å£„ÅüÔºÅÂçàÂæå„ÅÆÊéàÊ•≠„ÇÇÈ†ëÂºµ„Çå„Åù„ÅÜÔºÅ",
                "„Åä„Åã„Çè„ÇäÊ¨≤„Åó„Åè„Å™„Å£„Å°„ÇÉ„Å£„ÅüÔºÅ"
            ],
            mid: [ 
                "„Åæ„ÅÇ„Åæ„ÅÇ„Åã„Å™ÔºÅÂ´å„ÅÑ„Å™„ÇÇ„ÅÆ„Åò„ÇÉ„Å™„Åè„Å¶„Çà„Åã„Å£„Åü„ÄÇ",
                "„ÅÇ„Çä„Åå„Å®„ÅÜ„ÄÅÊôÆÈÄö„ÅÆÁµ¶È£ü„Å£„Å¶ÊÑü„Åò„ÅßÂÆâÂøÉ„Åô„Çã„Å≠„ÄÇ",
                "Ê¨°„ÅØ„Éá„Ç∂„Éº„Éà„ÇíÂ§ö„ÇÅ„Å´„ÅäÈ°ò„ÅÑ„Åß„Åç„Çã„Åã„Å™Ôºü",
                "Áâõ‰π≥„Åå„Çà„ÅèÂÜ∑„Åà„Å¶„Å¶ÁæéÂë≥„Åó„Åã„Å£„Åü„Çà„ÄÇ",
                "ÊâãÈöõ„ÅØËâØ„Åã„Å£„Åü„Å≠ÔºÅ„Åæ„Åü„Çà„Çç„Åó„ÅèÈ†º„ÇÄ„Çà„ÄÇ",
                "„ÅäËÖπ„ÅÑ„Å£„Å±„ÅÑ„Å´„Å™„Å£„Åü„Çà„ÄÇ„Åî„Å°„Åù„ÅÜ„Åï„Åæ„ÄÇ"
            ],
            low: [ 
                "„ÅÜ„Éº„Çì‚Ä¶ÁßÅ„ÅåÈ£ü„Åπ„Åü„Åã„Å£„Åü„ÅÆ„ÅØ„Åì„Çå„Åò„ÇÉ„Å™„ÅÑ„Åã„ÇÇ„ÄÇ",
                "„ÇÇ„Å£„Å®Êó©„ÅèÈÖçËÜ≥„Åó„Å¶„Åè„Çå„Å™„ÅÑ„Å®Êòº‰ºë„Åø„ÅåÁµÇ„Çè„Å£„Å°„ÇÉ„ÅÜ„Çà„ÄÇ",
                "Ê†ÑÈ§ä„Éê„É©„É≥„Çπ„ÅØ‚Ä¶„Å°„Çá„Å£„Å®ÂÅè„Å£„Å¶„Åü„Åã„Å™Ôºü",
                "„ÅäËÖπ„ÅØËÜ®„Çå„Åü„Åë„Å©„ÄÅÂøÉ„ÅØÊ∫Ä„Åü„Åï„Çå„Å™„ÅÑ„Å™„ÅÇ„ÄÇ",
                "Áµ¶È£üÂΩìÁï™„ÄÅÊ¨°„ÅØ„ÇÇ„Å£„Å®È†ëÂºµ„Å£„Å¶„Å≠‚Ä¶",
                "ÊÆãÈ£ØÊï¥ÁêÜ‰øÇ„Åò„ÇÉ„Å™„ÅÑ„Çì„Å†„Åã„Çâ„ÄÅ„Å°„ÇÉ„Çì„Å®ÈÅ∏„Çì„Åß„Çà„Äú"
            ]
        };

        // --- Sound Engine ---
        class SoundEngine {
            constructor() {
                this.ctx = null;
                this.bgmGame = document.getElementById('bgm-game');
                this.bgmResult = document.getElementById('bgm-result');
            }
            init() {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                this.bgmGame.load();
                this.bgmResult.load();
            }
            playTone(freq, type, duration, volume = 0.1, time = 0) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + time);
                gain.gain.setValueAtTime(volume, this.ctx.currentTime + time);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + time + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + time);
                osc.stop(this.ctx.currentTime + time + duration);
            }
            playCorrect() { this.playTone(880, 'sine', 0.1, 0.2); this.playTone(1760, 'sine', 0.2, 0.2, 0.1); }
            playWrong() { this.playTone(150, 'sawtooth', 0.3, 0.15); this.playTone(100, 'sawtooth', 0.3, 0.15, 0.1); }
            playRefresh() { this.playTone(440, 'square', 0.1, 0.1); this.playTone(660, 'square', 0.1, 0.1, 0.05); }
            playBGM(type) {
                this.stopBGM();
                const bgm = type === 'game' ? this.bgmGame : this.bgmResult;
                bgm.volume = 0.4;
                bgm.currentTime = 0;
                bgm.play().catch(e => console.log("BGM Blocked", e));
            }
            stopBGM() {
                this.bgmGame.pause();
                this.bgmResult.pause();
            }
        }
        const audio = new SoundEngine();

        // --- Game State ---
        let state = {
            score: 0,
            time: 60,
            combo: 0,
            served: 0,
            currentStudent: null,
            currentHint: null, 
            hand: [], 
            gameActive: false,
            usedStudents: [],
            isHard: false
        };

        // --- DOM Elements ---
        const els = {
            screens: document.querySelectorAll('.screen'),
            startBtn: document.getElementById('start-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            hardToggle: document.getElementById('hard-mode-toggle'),
            score: document.getElementById('score'),
            timer: document.getElementById('timer'),
            combo: document.getElementById('combo'),
            served: document.getElementById('served'),
            studentCard: document.getElementById('current-student'),
            menuGrid: document.getElementById('menu-grid'),
            reaction: document.getElementById('reaction-message'),
            container: document.querySelector('.game-container')
        };

        // --- Core Logic ---
        function switchScreen(id) {
            els.screens.forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function startGame() {
            audio.init();
            state.score = 0;
            state.time = 60;
            state.combo = 0;
            state.served = 0;
            state.gameActive = true;
            state.usedStudents = [];
            state.isHard = els.hardToggle.checked;
            
            // ÊâãÊú≠„ÅÆÂàùÊúüÂåñ
            state.hand = [];
            for(let i=0; i<12; i++) {
                state.hand.push(getRandomMenuItem());
            }

            els.container.classList.remove('hurry-up', 'fever-mode');
            updateHUD();
            renderMenu();
            nextStudent();
            switchScreen('game-screen');
            audio.playBGM('game');

            const timerId = setInterval(() => {
                if (!state.gameActive) { clearInterval(timerId); return; }
                state.time--;
                if (state.time <= 15) els.container.classList.add('hurry-up');
                updateHUD();
                if (state.time <= 0) endGame();
            }, 1000);
        }

        function getRandomMenuItem() {
            return menuDatabase[Math.floor(Math.random() * menuDatabase.length)];
        }

        function nextStudent() {
            let s = students[Math.floor(Math.random() * students.length)];
            state.currentStudent = s;

            const hintObj = hintTypes[Math.floor(Math.random() * hintTypes.length)];
            state.currentHint = hintObj;

            // Ë©∞„ÅøÈò≤Ê≠¢
            const hasMatch = state.hand.some(item => item.tags.includes(hintObj.tag));
            if (!hasMatch) {
                const matchingItems = menuDatabase.filter(m => m.tags.includes(hintObj.tag));
                const forcedItem = matchingItems[Math.floor(Math.random() * matchingItems.length)];
                const replaceIdx = Math.floor(Math.random() * 12);
                state.hand[replaceIdx] = forcedItem;
                renderMenu(replaceIdx);
            }

            // ‚òÖÂ§âÊõ¥ÁÇπÔºös.face.normal „ÇíË°®Á§∫
            els.studentCard.innerHTML = `
                <div class="student-face">${s.face.normal}</div>
                <div class="student-name">${s.name}</div>
                <div class="student-comment-box">${hintObj.label}</div>
            `;
            els.reaction.className = 'reaction-msg';
            els.studentCard.classList.remove('shake');
        }

        function renderMenu(animIndex = -1) {
            els.menuGrid.innerHTML = '';
            state.hand.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = 'menu-btn';
                if (index === animIndex) btn.classList.add('new-item');
                
                btn.innerHTML = `${item.name}`;
                btn.onpointerdown = (e) => {
                    e.preventDefault();
                    handleInput(item, index, btn);
                };
                els.menuGrid.appendChild(btn);
            });
        }

        function handleInput(item, index, btnEl) {
            if (!state.gameActive) return;

            const isMatch = item.tags.includes(state.currentHint.tag);
            
            // ‚òÖÂ§âÊõ¥ÁÇπÔºöÈ°î„ÅÆDOMË¶ÅÁ¥†„ÇíÂèñÂæó
            const faceEl = els.studentCard.querySelector('.student-face');

            let points = 0;
            let type = '';
            let msg = '';

            if (isMatch) {
                type = 'good';
                points = 100 + (state.combo * 10);
                state.combo++;
                msg = "„Éä„Ç§„ÇπÔºÅ";
                audio.playCorrect();
                state.served++;
                
                // ‚òÖÂ§âÊõ¥ÁÇπÔºöÊ≠£Ëß£„ÅÆÈ°î„ÇíË°®Á§∫
                faceEl.textContent = state.currentStudent.face.good;

                setTimeout(nextStudent, 600);
            } else {
                type = 'bad';
                points = -50;
                state.combo = 0;
                msg = "„Åà„Éº‚Ä¶ÈÅï„ÅÜ„Çà";
                audio.playWrong();
                els.studentCard.classList.add('shake');
                if(navigator.vibrate) navigator.vibrate(200);

                // ‚òÖÂ§âÊõ¥ÁÇπÔºö‰∏çÊ≠£Ëß£„ÅÆÈ°î„ÇíË°®Á§∫
                faceEl.textContent = state.currentStudent.face.bad;
            }

            state.score += points;
            showFloatingScore(points, btnEl);
            updateHUD();

            els.reaction.textContent = msg;
            els.reaction.className = `reaction-msg show ${type}`;

            // „Çπ„É≠„ÉÉ„ÉàË£úÂÖÖ
            const newItem = getRandomMenuItem();
            state.hand[index] = newItem;
            
            btnEl.innerHTML = newItem.name;
            btnEl.classList.remove('new-item');
            void btnEl.offsetWidth; 
            btnEl.classList.add('new-item');
            
            btnEl.onpointerdown = (e) => {
                e.preventDefault();
                handleInput(newItem, index, btnEl);
            };

            if (state.combo >= 5) els.container.classList.add('fever-mode');
            else els.container.classList.remove('fever-mode');
        }

        els.refreshBtn.onclick = () => {
            if (!state.gameActive) return;
            state.time -= 5;
            audio.playRefresh();
            
            const p = document.createElement('div');
            p.className = 'time-penalty';
            p.textContent = "-5";
            els.timer.parentNode.appendChild(p);
            setTimeout(() => p.remove(), 1000);

            for(let i=0; i<12; i++) {
                state.hand[i] = getRandomMenuItem();
            }
            
            const hintTag = state.currentHint.tag;
            const hasMatch = state.hand.some(item => item.tags.includes(hintTag));
            if (!hasMatch) {
                const matchingItems = menuDatabase.filter(m => m.tags.includes(hintTag));
                state.hand[Math.floor(Math.random()*12)] = matchingItems[Math.floor(Math.random()*matchingItems.length)];
            }
            
            renderMenu(); 
            updateHUD();
        };

        function showFloatingScore(points, targetEl) {
            const rect = targetEl.getBoundingClientRect();
            const el = document.createElement('div');
            el.className = 'float-score';
            el.textContent = points > 0 ? `+${points}` : points;
            el.style.color = points > 0 ? '#f1c40f' : '#e74c3c';
            el.style.left = (rect.left + rect.width/2 - 20) + 'px';
            el.style.top = (rect.top) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function updateHUD() {
            els.score.textContent = state.score;
            els.timer.textContent = Math.max(0, state.time);
            els.combo.textContent = state.combo;
            els.served.textContent = state.served;
        }

        function endGame() {
            state.gameActive = false;
            audio.playBGM('result');
            
            let rank = 'C';
            let commentPool = endingComments.low;

            if (state.score >= 4000) { rank = 'SSS'; commentPool = endingComments.high; }
            else if (state.score >= 3000) { rank = 'S'; commentPool = endingComments.high; }
            else if (state.score >= 2000) { rank = 'A'; commentPool = endingComments.mid; }
            else if (state.score >= 1000) { rank = 'B'; commentPool = endingComments.mid; }

            document.getElementById('final-rank').textContent = rank;
            document.getElementById('final-score').textContent = state.score;
            document.getElementById('final-combo').textContent = state.combo;

            // „Ç≥„É°„É≥„Éà„ÅÆÊäΩÈÅ∏„Å®Ë°®Á§∫
            const commentsList = document.getElementById('result-comments-list');
            commentsList.innerHTML = '';
            
            const shuffled = [...commentPool].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, 3);
            
            selected.forEach(text => {
                const s = students[Math.floor(Math.random() * students.length)];
                const div = document.createElement('div');
                div.className = 'student-voice';
                // ÁµêÊûúÁô∫Ë°®„Åß„ÅØÈÄöÂ∏∏È°î„Çí‰ΩøÁî®
                div.innerHTML = `<span style="font-size:1.5rem">${s.face.normal}</span><span>${text}</span>`;
                commentsList.appendChild(div);
            });
            
            switchScreen('result-screen');
        }

        // Event Listeners
        els.startBtn.onclick = startGame;
        document.getElementById('restart-btn').onclick = startGame;
        document.getElementById('title-btn').onclick = () => {
            audio.stopBGM();
            switchScreen('title-screen');
        };

        document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
    </script>
</body>
</html>
